name: Build MicroShift OS

on:
  workflow_dispatch:
    inputs:
      microshift_version:
        description: 'MicroShift Version (default: release-4.19)'
        default: 'release-4.19'
      iso_config:
        description: 'ISO Configuration'
        default: 'user'
        type: choice
        options: ['minimal', 'user', 'advanced', 'interactive']
      build_iso:
        description: 'Build ISO'
        default: true
        type: boolean

env:
  IMAGE_NAME: ramaedge-os-microshift
  REGISTRY: ghcr.io
  REPO_OWNER: ramaedge

jobs:
  build-and-scan:
    name: Build MicroShift OS
    runs-on: ubuntu-22.04
    outputs:
      image-ref: ${{ steps.build.outputs.image-ref }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate version
        id: version
        uses: ./.github/actions/calculate-version

      - name: Set MicroShift version
        id: microshift
        run: |
          VERSION="${{ github.event.inputs.microshift_version || 'release-4.19' }}"
          echo "microshift-version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Using MicroShift version: ${VERSION}"

      - name: Build container image
        id: build
        uses: ./.github/actions/build-container
        with:
          image-name: ${{ env.IMAGE_NAME }}
          image-tag: ${{ steps.version.outputs.version }}
          containerfile: Containerfile.fedora.optimized
          working-path: ./os
          registry: ${{ env.REGISTRY }}
          repository-owner: ${{ env.REPO_OWNER }}
          microshift-version: ${{ steps.microshift.outputs.microshift-version }}

      - name: Security scan
        uses: ./.github/actions/trivy-scan
        with:
          scan-type: 'container'
          scan-ref: ${{ steps.build.outputs.image-ref }}
          severity: 'CRITICAL,HIGH'
          output-format: 'sarif'
          generate-sbom: 'true'
          upload-sarif: 'true'
          sarif-category: 'trivy-container-microshift'

      - name: Test container image
        uses: ./.github/actions/test-container
        with:
          image-ref: ${{ steps.build.outputs.image-ref }}
          test-type: 'microshift'
          parallel: 'true'

  build-iso:
    name: Build ISO
    runs-on: ubuntu-22.04
    needs: build-and-scan
    if: github.event.inputs.build_iso == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build MicroShift ISO
        id: iso
        uses: ./.github/actions/build-iso
        with:
          image-ref: ${{ needs.build-and-scan.outputs.image-ref }}
          config: ${{ github.event.inputs.iso_config || 'user' }}
          output-dir: 'iso-output'
          working-path: './os'

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: microshift-os-iso-${{ github.event.inputs.iso_config }}-v${{ needs.build-and-scan.outputs.version }}
          path: ${{ steps.iso.outputs.iso-path }}
          retention-days: 30 