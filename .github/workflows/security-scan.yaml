name: 'Security Scan'

on:
  push:
    branches: ['main']
    paths: ['os/**', '.github/workflows/**', 'configs/**', 'scripts/**']
  pull_request:
    branches: ['main'] 
    paths: ['os/**', '.github/workflows/**', 'configs/**', 'scripts/**']
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      severity:
        description: 'Scan severity'
        default: 'CRITICAL,HIGH'
        type: choice
        options: ['CRITICAL,HIGH', 'CRITICAL,HIGH,MEDIUM', 'CRITICAL,HIGH,MEDIUM,LOW']

jobs:
  security-scan:
    name: Security Scan
    runs-on: self-hosted
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        scan-type:
          - type: 'fs'
            name: 'Filesystem'
            category: 'trivy-filesystem'
          - type: 'config'
            name: 'Configuration'
            category: 'trivy-config'
          - type: 'secret'
            name: 'Secret Detection'
            category: 'trivy-secrets'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ${{ matrix.scan-type.name }} scan
        id: scan
        uses: ./.github/actions/trivy-scan
        with:
          scan-type: ${{ matrix.scan-type.type }}
          scan-ref: '.'
          output-format: 'sarif'
          severity: ${{ github.event.inputs.severity || 'CRITICAL,HIGH' }}

      - name: Display scan results
        uses: ./.github/actions/trivy-scan
        with:
          scan-type: ${{ matrix.scan-type.type }}
          scan-ref: '.'
          output-format: 'table'
          severity: ${{ github.event.inputs.severity || 'CRITICAL,HIGH' }}

      - name: Upload results to Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: ${{ steps.scan.outputs.results-file }}
          category: ${{ matrix.scan-type.category }}

  summary:
    name: Scan Summary
    runs-on: self-hosted
    needs: security-scan
    if: always()
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ”’ Security Scan Results
          
          **Trigger**: ${{ github.event_name }}  
          **Severity**: ${{ github.event.inputs.severity || 'CRITICAL,HIGH' }}  
          **Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          ### Scans Completed
          - âœ… **Filesystem**: Source code and dependencies
          - âœ… **Configuration**: Dockerfiles, YAML files, etc.
          - âœ… **Secrets**: API keys, credentials, tokens
          
          ### Results
          - **Console**: Detailed results in workflow logs
          - **Security Tab**: SARIF results uploaded for tracking
          - **Schedule**: Daily scans at 2:00 AM UTC
          
          Check the Security tab for vulnerability details and trends.
          EOF 